# Understand Fusion UF accuracy improvement

In rotated surface code with code distance $d=5$ and $p=0.05$, the accuracy is:
- fusion blossom (MWPM decoder): 0.0165(2)
- fusion UF (`max_tree_size = 0`): 0.0193(2)
- native UF decoder: 0.0202(2)

We want to understand the difference between fusion UF and the native UF.
Intuitively, they should have the same logical error rate because the cluster shape are all the same.
(I have confirmed that the fusion UF decoder never shrinks a cluster)

Most interestingly, if properly implemented, fusion UF should have exactly the same time complexity as the native UF decoder.
This is because the blossoms are always created in a 3-node cycle, making it constant time overhead.
Also, the benefit may come from the fact that we maintain the `touching` node when reporting the obstacles.
However, this is still a constant memory and speed overhead.

## Experiment

To get `fusion.failed` and `uf.failed`,

```sh
make
grep -n '"qec_failed":true' fusion.stats > fusion.failed
grep -n '"qec_failed":true' uf.stats > uf.failed
```

There are 175 failed cases for fusion UF but 207 failed cases for UF.

```sh
cat fusion.failed | cut -d: -f1 | tr '\n' ','
# 19,24,51,96,217,275,302,333,337,384,415,418,440,480,524,638,743,777,841,852,1041,1073,1107,1138,1139,1184,1198,1268,1283,1327,1426,1429,1447,1483,1594,1600,1622,1639,1663,1716,1721,1736,1744,1879,1927,2029,2058,2069,2089,2108,2133,2253,2254,2318,2434,2582,2662,2804,2933,3002,3185,3218,3301,3330,3345,3353,3412,3460,3480,3507,3581,3605,3633,3677,3822,3832,3837,3853,3854,3873,3963,4009,4050,4241,4331,4363,4370,4451,4540,4555,4568,4741,4843,4848,4872,4887,5066,5134,5160,5173,5206,5218,5231,5261,5371,5407,5431,5434,5471,5535,5657,5676,5704,5706,5753,5834,5840,5852,5873,5917,6038,6123,6159,6167,6214,6243,6263,6329,6351,6370,6434,6467,6478,6486,6504,6622,6713,6755,6886,6898,6960,6964,7120,7176,7230,7243,7415,7448,7512,7530,7549,7631,7738,7779,7818,7827,7883,7885,7960,8024,8089,8106,8115,8119,8164,8212,8284,8333,8344,8441,8469,8487,8498,8653,8713
cat uf.failed | cut -d: -f1 | tr '\n' ','
# 24,51,96,207,217,275,302,317,333,337,384,415,418,440,480,524,533,638,743,777,852,981,1041,1073,1080,1107,1138,1139,1184,1191,1198,1283,1327,1426,1427,1429,1447,1483,1536,1594,1600,1614,1622,1639,1663,1668,1716,1721,1736,1744,1879,1927,2029,2058,2069,2108,2133,2150,2253,2254,2317,2318,2434,2582,2662,2785,2804,2933,3002,3185,3187,3218,3301,3330,3345,3412,3460,3480,3507,3581,3605,3633,3677,3777,3822,3832,3837,3853,3854,3873,3963,4050,4150,4241,4331,4451,4540,4555,4568,4741,4843,4848,4872,4887,4893,4925,5066,5079,5160,5173,5206,5218,5231,5261,5371,5407,5431,5434,5471,5483,5531,5535,5657,5676,5704,5706,5753,5834,5840,5852,5873,5898,5917,6038,6123,6159,6167,6214,6243,6273,6289,6329,6351,6370,6467,6478,6486,6504,6622,6713,6755,6886,6898,6960,6964,7002,7120,7176,7230,7280,7415,7448,7473,7512,7530,7549,7630,7631,7738,7742,7779,7818,7827,7835,7883,7960,8089,8106,8115,8119,8164,8212,8284,8333,8344,8469,8487,8498,8653,8713,8832,8838,9118,9148,9212,9217,9332,9403,9534,9541,9574,9575,9600,9665,9727,9826,9975
python3 analyze.py
# fusion_only: 15
# uf_only: 47
# shared: 160
```

These are the fusion-uf only failures:

```shell
[19]: {'[0][3][5]': 'Y', '[0][7][5]': 'Z', '[0][7][7]': 'Z'}
[841]: {'[0][3][5]': 'Z', '[0][6][4]': 'Z', '[0][9][5]': 'Z'}
[1268]: {'[0][5][3]': 'X', '[0][5][9]': 'X', '[0][6][6]': 'Y'}
[2089]: {'[0][2][6]': 'Z', '[0][4][8]': 'Y', '[0][7][7]': 'Y'}
[3353]: {'[0][5][5]': 'X', '[0][6][8]': 'Y', '[0][8][4]': 'X'}
[4009]: {'[0][2][6]': 'Y', '[0][5][7]': 'Y', '[0][5][9]': 'Y', '[0][8][4]': 'X', '[0][9][5]': 'X'}
[4363]: {'[0][2][6]': 'Z', '[0][5][5]': 'Z', '[0][5][7]': 'Z', '[0][5][9]': 'Z'}
[4370]: {'[0][3][3]': 'Z', '[0][5][7]': 'Y', '[0][7][5]': 'X', '[0][9][5]': 'X'}
[5134]: {'[0][3][3]': 'X', '[0][3][5]': 'Y', '[0][5][7]': 'Y', '[0][5][9]': 'Y'}
[6263]: {'[0][2][6]': 'Z', '[0][4][6]': 'Z', '[0][5][9]': 'Z', '[0][6][6]': 'Z'}
[6434]: {'[0][2][4]': 'X', '[0][4][6]': 'Y', '[0][7][3]': 'X', '[0][7][7]': 'Y'}
[7243]: {'[0][2][6]': 'Z', '[0][4][8]': 'Y', '[0][6][8]': 'Z', '[0][7][7]': 'X'}
[7885]: {'[0][5][7]': 'Y', '[0][7][3]': 'Y', '[0][8][6]': 'X'}
[8024]: {'[0][3][5]': 'Y', '[0][4][4]': 'X', '[0][6][4]': 'X', '[0][6][6]': 'X', '[0][8][4]': 'Z', '[0][9][5]': 'X'}
[8441]: {'[0][3][5]': 'Z', '[0][6][4]': 'Y', '[0][6][8]': 'Z'}
```

These are the native UF only failures:

```shell
[207]: {'[0][6][6]': 'Z', '[0][6][8]': 'Y', '[0][7][3]': 'Y'}
[317]: {'[0][2][6]': 'Y', '[0][3][3]': 'X', '[0][5][3]': 'X'}
[533]: {'[0][1][5]': 'Y', '[0][2][6]': 'Z', '[0][6][6]': 'Z'}
[981]: {'[0][2][4]': 'Y', '[0][4][4]': 'Y', '[0][6][6]': 'Z'}
[1080]: {'[0][3][3]': 'Y', '[0][3][5]': 'Y', '[0][7][5]': 'Z'}
[1191]: {'[0][3][5]': 'Y', '[0][3][7]': 'Y', '[0][7][5]': 'X'}
[1427]: {'[0][3][3]': 'Z', '[0][3][5]': 'X', '[0][4][4]': 'Z', '[0][8][4]': 'Z'}
[1536]: {'[0][1][5]': 'Z', '[0][4][4]': 'Y', '[0][5][3]': 'Z', '[0][7][5]': 'Y'}
[1614]: {'[0][3][7]': 'X', '[0][6][4]': 'X', '[0][6][6]': 'Y'}
[1668]: {'[0][2][4]': 'Y', '[0][3][5]': 'X', '[0][4][2]': 'X', '[0][5][5]': 'Z', '[0][5][9]': 'X', '[0][6][6]': 'Z', '[0][7][5]': 'Y'}
[2150]: {'[0][2][4]': 'X', '[0][3][7]': 'X', '[0][4][2]': 'Y', '[0][5][3]': 'Z'}
[2317]: {'[0][6][4]': 'Y', '[0][6][8]': 'X', '[0][7][3]': 'X', '[0][7][7]': 'Z'}
[2785]: {'[0][3][5]': 'X', '[0][6][2]': 'Y', '[0][8][6]': 'Y', '[0][9][5]': 'X'}
[3187]: {'[0][4][8]': 'Y', '[0][5][3]': 'Y', '[0][5][9]': 'Z'}
[3777]: {'[0][4][2]': 'Y', '[0][5][5]': 'Y', '[0][8][4]': 'Y'}
[4150]: {'[0][4][2]': 'X', '[0][4][6]': 'X', '[0][5][1]': 'X'}
[4893]: {'[0][3][7]': 'X', '[0][4][2]': 'X', '[0][4][4]': 'X', '[0][5][9]': 'Z'}
[4925]: {'[0][3][3]': 'Y', '[0][4][4]': 'Y', '[0][5][3]': 'Z', '[0][8][4]': 'Y'}
[5079]: {'[0][3][3]': 'Z', '[0][3][5]': 'Z', '[0][4][2]': 'X', '[0][7][5]': 'Z'}
[5483]: {'[0][6][4]': 'Z', '[0][8][4]': 'Y', '[0][8][6]': 'Z'}
[5531]: {'[0][4][6]': 'Y', '[0][4][8]': 'Y', '[0][6][4]': 'X'}
[5898]: {'[0][3][3]': 'Z', '[0][3][5]': 'Y', '[0][7][5]': 'Z'}
[6273]: {'[0][4][2]': 'Z', '[0][4][4]': 'X', '[0][5][9]': 'Z', '[0][7][3]': 'Z', '[0][7][5]': 'Y'}
[6289]: {'[0][3][3]': 'Y', '[0][6][6]': 'Y', '[0][7][3]': 'Z'}
[7002]: {'[0][2][4]': 'Y', '[0][2][6]': 'X', '[0][4][2]': 'Y', '[0][6][6]': 'Z'}
[7280]: {'[0][3][5]': 'Z', '[0][4][2]': 'Y', '[0][5][1]': 'Z', '[0][5][7]': 'Z'}
[7473]: {'[0][4][4]': 'Z', '[0][5][3]': 'Z', '[0][6][2]': 'Z', '[0][8][4]': 'Z'}
[7630]: {'[0][4][2]': 'Y', '[0][5][7]': 'Z', '[0][6][4]': 'Z'}
[7742]: {'[0][1][5]': 'Y', '[0][3][5]': 'Y', '[0][8][4]': 'Z'}
[7835]: {'[0][4][2]': 'Y', '[0][4][6]': 'X', '[0][6][2]': 'X'}
[8832]: {'[0][2][6]': 'Y', '[0][3][7]': 'Z', '[0][6][8]': 'Y'}
[8838]: {'[0][6][2]': 'Z', '[0][7][3]': 'Y', '[0][7][5]': 'Y'}
[9118]: {'[0][4][6]': 'Y', '[0][5][5]': 'Y', '[0][8][4]': 'X'}
[9148]: {'[0][4][8]': 'X', '[0][5][7]': 'X', '[0][7][7]': 'X', '[0][9][5]': 'Y'}
[9212]: {'[0][5][3]': 'X', '[0][5][5]': 'X', '[0][5][9]': 'X'}
[9217]: {'[0][4][8]': 'X', '[0][5][3]': 'X', '[0][5][7]': 'X'}
[9332]: {'[0][2][6]': 'Y', '[0][4][6]': 'Y', '[0][6][4]': 'X'}
[9403]: {'[0][4][2]': 'Y', '[0][7][7]': 'Y', '[0][8][4]': 'Z', '[0][8][6]': 'Y'}
[9534]: {'[0][3][3]': 'X', '[0][3][5]': 'X', '[0][5][9]': 'Z', '[0][6][2]': 'X'}
[9541]: {'[0][4][6]': 'Y', '[0][5][7]': 'Y', '[0][6][6]': 'Z', '[0][8][6]': 'Y', '[0][9][5]': 'Y'}
[9574]: {'[0][3][5]': 'X', '[0][4][2]': 'X', '[0][4][6]': 'Z', '[0][5][3]': 'Y', '[0][5][7]': 'Y', '[0][7][7]': 'Z'}
[9575]: {'[0][3][3]': 'Y', '[0][3][5]': 'Y', '[0][3][7]': 'Y', '[0][7][3]': 'X'}
[9600]: {'[0][2][4]': 'Y', '[0][2][6]': 'Y', '[0][3][3]': 'Z', '[0][6][6]': 'Y', '[0][6][8]': 'X'}
[9665]: {'[0][2][4]': 'Y', '[0][3][5]': 'X', '[0][5][5]': 'Y', '[0][6][6]': 'Z', '[0][8][4]': 'X'}
[9727]: {'[0][2][6]': 'X', '[0][4][2]': 'X', '[0][4][6]': 'X'}
[9826]: {'[0][4][4]': 'Y', '[0][5][1]': 'X', '[0][5][3]': 'X', '[0][5][9]': 'X'}
[9975]: {'[0][6][6]': 'Y', '[0][6][8]': 'Y', '[0][7][5]': 'Y'}
```

Some examples of the shared errors are below:

```shell
[24]: {'[0][3][3]': 'Y', '[0][8][4]': 'Z', '[0][9][5]': 'Y'}
[51]: {'[0][3][5]': 'X', '[0][4][4]': 'Z', '[0][4][6]': 'Y', '[0][5][7]': 'Z'}
[96]: {'[0][2][6]': 'X', '[0][5][3]': 'Y', '[0][6][2]': 'X'}
[217]: {'[0][4][2]': 'Y', '[0][4][6]': 'Y', '[0][5][7]': 'Y'}
[275]: {'[0][4][2]': 'Z', '[0][5][5]': 'X', '[0][5][7]': 'X', '[0][6][2]': 'Y'}
[302]: {'[0][4][8]': 'X', '[0][5][5]': 'X', '[0][5][7]': 'X'}
[333]: {'[0][3][5]': 'X', '[0][4][4]': 'Y', '[0][5][3]': 'X'}
[337]: {'[0][2][4]': 'Y', '[0][2][6]': 'Y', '[0][5][9]': 'Z', '[0][6][6]': 'Z'}
[384]: {'[0][3][7]': 'X', '[0][4][6]': 'X', '[0][5][3]': 'Y'}
[415]: {'[0][4][8]': 'X', '[0][6][6]': 'Y', '[0][9][5]': 'Y'}
[418]: {'[0][4][4]': 'Z', '[0][6][4]': 'Z', '[0][6][6]': 'Y', '[0][8][4]': 'X'}
[440]: {'[0][1][5]': 'X', '[0][2][4]': 'X', '[0][6][2]': 'Y', '[0][6][6]': 'Y', '[0][8][4]': 'Z'}
[480]: {'[0][4][6]': 'X', '[0][5][5]': 'Y', '[0][8][4]': 'Y'}
[524]: {'[0][2][4]': 'Y', '[0][3][5]': 'Z', '[0][6][6]': 'Z'}
[638]: {'[0][4][6]': 'Z', '[0][5][3]': 'Y', '[0][5][9]': 'Y', '[0][9][5]': 'X'}
[743]: {'[0][1][5]': 'X', '[0][2][4]': 'Y', '[0][6][4]': 'Y', '[0][6][6]': 'Y'}
[777]: {'[0][2][6]': 'Z', '[0][4][4]': 'Y', '[0][6][4]': 'Y', '[0][7][5]': 'Z', '[0][7][7]': 'Z'}
[852]: {'[0][3][3]': 'Z', '[0][6][4]': 'Y', '[0][6][6]': 'Y'}
[1041]: {'[0][4][8]': 'Y', '[0][6][8]': 'X', '[0][7][5]': 'Y', '[0][8][6]': 'Z'}
[1073]: {'[0][4][8]': 'X', '[0][7][5]': 'Y', '[0][8][4]': 'X'}
[1107]: {'[0][2][6]': 'Z', '[0][3][3]': 'X', '[0][5][7]': 'Z', '[0][6][8]': 'Z'}
[1138]: {'[0][3][5]': 'Y', '[0][4][4]': 'Y', '[0][5][1]': 'Y', '[0][6][8]': 'Y', '[0][7][3]': 'Z'}
[1139]: {'[0][4][2]': 'Z', '[0][6][2]': 'Y', '[0][7][5]': 'Y'}
[1184]: {'[0][3][3]': 'Y', '[0][3][7]': 'Y', '[0][4][2]': 'X'}
[1198]: {'[0][2][6]': 'Y', '[0][6][6]': 'Y', '[0][7][5]': 'X'}
[1283]: {'[0][3][3]': 'Y', '[0][7][3]': 'Y', '[0][7][7]': 'Z', '[0][8][6]': 'Z'}
[1327]: {'[0][4][2]': 'Y', '[0][4][6]': 'Y', '[0][6][2]': 'Z', '[0][7][5]': 'Z', '[0][8][6]': 'Z'}
[1426]: {'[0][1][5]': 'Y', '[0][2][6]': 'Z', '[0][5][9]': 'Y'}
[1429]: {'[0][5][5]': 'Y', '[0][5][9]': 'Y', '[0][6][4]': 'X'}
[1447]: {'[0][3][7]': 'X', '[0][4][6]': 'X', '[0][6][8]': 'X', '[0][7][5]': 'Y'}
[1483]: {'[0][2][4]': 'Y', '[0][3][7]': 'Z', '[0][4][8]': 'Y'}
[1594]: {'[0][5][9]': 'Y', '[0][8][6]': 'X', '[0][9][5]': 'Y'}
[1600]: {'[0][1][5]': 'Z', '[0][2][6]': 'Y', '[0][5][9]': 'Z', '[0][6][4]': 'X'}
[1622]: {'[0][2][4]': 'Y', '[0][4][2]': 'X', '[0][4][4]': 'X', '[0][7][5]': 'Y', '[0][8][4]': 'Y'}
[1639]: {'[0][5][3]': 'X', '[0][5][5]': 'X', '[0][5][9]': 'X'}
[1663]: {'[0][3][5]': 'Z', '[0][5][7]': 'Y', '[0][7][7]': 'Y'}
[1716]: {'[0][3][3]': 'Z', '[0][5][3]': 'Z', '[0][5][5]': 'Y', '[0][6][4]': 'Y', '[0][9][5]': 'Y'}
[1721]: {'[0][6][2]': 'Z', '[0][6][6]': 'Z', '[0][7][7]': 'Y'}
[1736]: {'[0][4][2]': 'Y', '[0][5][3]': 'Z', '[0][7][3]': 'Z'}
[1744]: {'[0][3][3]': 'Y', '[0][5][3]': 'Y', '[0][6][4]': 'Z'}
[1879]: {'[0][1][5]': 'Z', '[0][6][6]': 'Z', '[0][6][8]': 'Y', '[0][7][7]': 'X'}
......

```

Compare these two files we get the following logical error cases
